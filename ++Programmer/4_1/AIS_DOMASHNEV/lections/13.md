Установка соединения по защищенному каналу

Сревер и клиент.

Первое что осуществляется - сервер предъявляет сертификат и клиент осуществляет его
валидацию.
Сертификат подтверждает, что клиент образаается именно к тому серверу к которому и хотел
обратиться, чтобы избержать лица посередине (злоумышленник)
TLS - SSL+
У клиента есть сертификаты корневых центров (от серверов) на доменное имя узла.

Генерируется 2 ключа - закрытый и публичный на стороне сервера и на стороне клиента
публичными ключами обмениваются и по нему шифруются сообщения
это Ассиметричное шифрование

теперь нужно сессионное шифрование для трафика
Root - 2, 3, 5 символов
Prime 300 символов
на каждом клиенте и на сервере

Происходит обмен данными - микстурами.
Данные с использованием закрытых ключей и чисел

Микстуры:
Root^(private_S) % prime -> на клиент
Root^(private_C) % prime -> на серверa

(C_M^Private_S) % prime
(S_M^Private_C) % prime
Сервер берет клиентскую, возводит в степень своего ключа и в результате числа получаются одинаковые

Смысл - разными путями придти к одному значению

Если посередине кто-то присутствует, то может установить 2 независимых соединения,
тогда у него 2 сессионных ключа и трафик будет переходить через него



# Архитектура веб-сервера IIS

2 режима - пользовательский и режим ядра.
Разделено на 2 состалвяющие:
в режиме ядра работает драйвер HTTP SYS
принимает запросы по протоколу HTTP
В составе IIS есть 2 сервиса - служба W3SWC и WAS
W3 == WWW
Начиная с 7 версии служба WAS выполняет большую роль

Есть рабочий процесс Working Process.
Есть некоторые этапы обработки HTTP-запроса и обработки HTTP-ответа
Файл конфигурации (состоит из нескольких частей конфигурации ИИС)
Для слежения за рабочим процессом с помощью контейнера - AppPool - не нечто программное, а
мониторинг за рабочим процессом

Функции:
задачи драйвера HTTP-SYS - прием и парсинг HTTP-запроса
Шифрование/расшифрование поддержание зашифрованных каналов тоже за HTTP-SYS
Он же отвечает за управление очередью запросов
Есть очередь в которой собираются запросы, адресованные на один и тот же ресурс (сайт)
Когда поступает запрос HTTP SYS проверяет в кеше есть ли куда передать запрос
(если недавно потупали запрос на текущий сайт, то просто передаст эти данные на
рабочий процесс, если нет, то передает информацию куда адресован запрос - HTTP, HTTPS, порт, IP, заголовок
из URL имени запроса)
дальше передает в WAS
WAS определяет какой сайт должен обработать запрос.
По тем данным, которые получаются у драйвера и настрайка привязок у веб сервера WAS понимает
куда перенаправить запрос. Если такой процесс у URL есть, то возвращает информацию куда надо
передать, если нет, то запускает эту службу. Собирает конфиги для сайта, объединяет с конфигами сервера
и этот единый конфиг копируется и защищается правами доступа
Доступ к конфигу разрешается только рабочему процессу. Сведения передаются до HTTP SYS.
У него есть кэш с соответствием привязка-рабочий процесс
Дальше драйвер HTTP SYS передает HTTP-запрос по указанному рабочему процессу.
HTTP запрос переходит через цикл этапов обработки процессов.

После обработки драйвер берет следующий запрос на обработку.

Задачи служюы WAS
Управление конфигом перед запуском, управление процессами, запуск
контроль ресурсов URL приложений
по достижении определенных событий перезапустить старый рабочий процесс.

В заадчи рабочего процесса - работа с was (предосталвение данных о своей работе)
Передача которая встроена внутри приложения.
Когда обработка доходит до какого-то момента, то происходит передача управления
веб-приложению - аутентификация, авторизация, журналирование.

Такой режим работы называется традиционным конвеером работы.
Есть вариант строенного (интегрированного режима работы)
приложение может подписываться (части подписываются на события выполнения этапов конвеера)
По завершении выполнится код приложения.
Код приложения модет выпонляться по чуть-чуть на каждом этапе разработки
То в каком режиме работы работает процесс (стандартный или интегрированный) настравивается
на уровне без-приложения
Рабочий процесс запускаемый службой WAS начинает работать

Кто должен осуществить обработку?

1. Протокол HTTP/HTTPS
2. IP адрес (на какой ip поступил запрос) - значение, либо все
3. Порт TCP - конкретное значение
4. Host header (hh) - DNS имя с запроса - значение, либо пусто
На сервере публикуется несколько сайтов.
Нужно чтобы комбинация была уникальна
Например:
Есть порт, но hh пустой. А есть тот же самый порт и разные hh.
Если будут дубликатные пакеты, то не получится разделить.


Разделения привязок.
По IP трудно
По портам можно, а вот публично трудно реализуемо.
Единственный вариант - hh
пусть Все 3 параметры одинаковые, но добавляется еще один параметр
www.companyA.ru
www.companyB.ru
www.companyC.ru
В DNS все эти имена будут разрешаться в один и тот же ip адрес.
Запросы будут поступать на один и тот же ip адрес.
При публиуации множества сайтов их нужно разделять по заголовкам хостов.
Для одного сайта может быть несколько привязок.
