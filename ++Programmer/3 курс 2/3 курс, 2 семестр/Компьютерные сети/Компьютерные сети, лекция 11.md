Добиваем канальный уровень

## Протокол HDLC
Человечество поэксперементировало в области канальных уровней, придумало один варинат, на базе которого основываются дальнейшее. Большинство канальных протоколов построены на HDLC - способ передачи кадра [порция данных, идущее по звену]
Структура кадра `[Address]``[Control]``[Inform]``[CRC]`
контрол - 1 или 2 байта (от режима зависит) определяет тип кадра.

В стандарте 3 вида кадра iframe[info], sframe[supervisor], uframe[unnumbered]
Контрол - физически представляет собой 1 байт и в зависимости от типа кадра выглядит так:
кадр определяется парой битов - 
0 0 - i, 
0 1 - s, 
1 1 - u

nr - номер кадра, который станция-отправитеь желает принять следующим.
ns - номер кадра, который сейчас  передается (только в i-frame -> передача данных в режиме ARQ)
Бит P/F (poll/finish) - если p, то мастер-станция отправляет s-frame с признаком 1.
Если это ответ, то признак говорит передачу закончил, пакета не будет.
Если посмотреть iframe, то он весь состоит из номеров (номер ожид, получ, p/f).
У s и u есть доп. подтипы:
s: 2 бита и 4 вариации - rr, rnr, reject(NAC), selective-reject -> примитивы ARQ протокола. Кадр довольно легкий.
u - 32 бит число


В HDLC естб несколько режимов обмена данных - канального уровня протокол potpo, multipo, 
datagram mode - станция отправила и всё - так работает Eth. Этот датаграммный режим не требует подтвержения на канальном уровне, передает тип ненумерованого кадра и кадр будет иметь биты B1=1 B0=1

ff03f:
ff-адрес (бродкаст)
03 - датаграмма
остальное - данные

В том режиме, когда идет обмен нумерованными кадрами - режим ARQ. Он двусторонний (в двух направлениях). Кадры противоположного направления выступают в виде ack, из-за чего можно при помощи данных приема подтверждать передачу. Как и в любом arq нужно вначале инициировать счетчики.

Есть несколько видов ARQ - nrm (master-slave)
ABM - async balance mode - двуточечный дюплекс вариант.

Как ABM - (potpo передают данные друг другу)
1. Установка соединения (хэндшейкинг) - передать ненумерованный кадр.
2. Если станция 2 согласна, то отвечает UA - unnumb ack.
3. В обеих станциях счетчики сбрасываются в 0 и начинается передача данных.

Передача данных:
передает iframe сразу. У этого кадра ns=0 и nr=0. То есть отправлю и ожидаю кадр=0. Приняв кадр данных станция должна ответить примитивом rr (receiver ready) готов к приему первого кадра. Станция s2 может отправить свой кадр с ns=0, а nr=2 (так как первый принят и ожидается второй). Третий кадр - nr=3.
в rr всегда ожидаемый (следующий кадр)

В HDLC 2 варианта ack. станция 2, получив кадр, передает rnr (я receive not ready - принял 2 кадр, но ещё не готов принять следующий). Это реализация Start-Stop flow control. Чтобы буфер не был переполнен.

## Протокол PPP
Роль PPP:
в реальной жизни нас окружает множетсво многоточечных сетей (вайфай). В условии этих сетей есть необходимость point-to-point соединение. Особенность двухточечных сетей локальны. Большой интернет построен на двуточечных линках. Есть провайдер 1 и провайдер 2. Между ними организуется один или несколько point-to-point линков.
Изначально варинатов point-to-point линков было множество.
Потом придумали PPP протокол. Физически это семейство протоколов.
Как оно устроено?
Давайте придуем унифированный кадр канального уровня (Uniform PPP Frame) Этот upppf может включаться в разные транспортные конверты[Каждый из них соотв. типу канала]:
HDLC-like -> адрес c d и crc - формат кадра , похожий на HDLC
d - унифицированный.
Так как каналы бывают синк и асинк, то бывает 2 вида инкапсуляции асинк ппп и синк ппп.

PPP UE - используется в домашних сетях.

Способы инкапсуляции
PPP Over Eth.
PPP over ATM
PPP over SDM
PPP over PRE/IP
PPP over L2TP


Центральная цасть кадра - состоит из кода протокола и ряда данных.
Все протоколы делятся на 2 категории:
1. Служебные (Control Protocol (CP)) - не переносят Payload
2. Network Protocol NCP - переносят Payload - может быть упаковано все что угодно -> кол-во NCP соответствует виду униф. пейловадов. Имеет айпи и айпи пакетю

Управляющие типы протоколов построены на одной схеме (станции отправляют пакеты)
Какие функции делают управляющие протоклы?
1. Установка соединения 
	1. Переговоры, в результате которых приходят к общему языу.

PPP сделан абстрактно - есть 2 пира, которые желают обмениваться данными друг с другом. Давайте способ обмена данными сформулируем в виде набора опций (option value)
Есть набор значений у одного и второго пира.
Есть код управляющего кадра, id (на что пришел запрос)

При установке соединения установлен порядок:
LCP - link control protocol - набор опций линка
Требуется Auth
Согласование Auth
Согласование NCP
Передача данных

Что такое magic?
Есть такой режим loop-back - создаются бесконечные беседы. Чтобы этого не было, в процессе установки соединения


# Поднимаемся на транспортный уровень

Транспортный протокол отвечает за доставку данных между эндпоинтами, которые соотв. SAP.  
Узел 1, а SAP может быть множество.
SAP могут быть на одном узле. Также являются динамически создаваемыми. 

Сокет - область в памяти , сам сокет живет в пространстве ядра с указателем на области памяти в ядре, который соотв. экземпляру транспортного протокола, тут есть приемный, отправляющий буферы. 
Сокет хенлд (файл хендл с числом).
Кроме них в составе области памяти есть протокол стейт. Большинство протоколов представляют собой сеть. 
Эндпоинт - точка доставки айпи пакета. Сокет - api для нашего приложения. 

Как приложение видит конструкцию
Между сапами есть несколько режимов. В датаграмме приложение посывлает короткие порции, каждая порция доставляется независимо от других. Гарантируется целостность, но не доставка и порядок. Размер сообщения ограничен (64кб). 
Второй режим - потокоориентированный (stream-based). Передача сети представляет не набор порций, а набор байтов со своими номерами. Транспортный уровень гарантирует доставку и порядок. Цена решения состоит в том, что границы порций не сохраняются
20 20 40 --> 30 30 20

